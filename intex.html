C 700.353 

<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Catalog with Cart & Categories</title>
  <style>
    * { box-sizing: border-box }
    body { margin:0; padding:0; font-family:Arial,sans-serif; background:#f5f5f5 }

    /* === Summary Cart Bar (MODIFIED for sticky position) === */
    #summaryCartBar {
      display: flex; /* Always a flex container */
      position: sticky; /* Makes the element stick to the top when scrolled */
      top: 0; /* Sticks to the very top of the viewport */
      z-index: 20; /* Ensures it stays above other content when scrolling */
      background: #f06292;
      color: white;
      padding: 8px 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #summaryCartBar:hover {
        background: #ec407a;
    }
    #summaryCartInfo {
        font-weight: bold;
        font-size: 14px;
    }
    #viewCartBtn {
        background: #fff;
        color: #d81b60;
        border: none;
        border-radius: 20px; /* Rounded corners for "View Cart" button */
        padding: 8px 15px;
        font-weight: bold;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    #viewCartBtn:hover {
        background: #fce4ec;
        transform: scale(1.05);
    }

    /* === Cart Modal (MODIFIED POSITION to appear below sticky bar) === */
    #cartModal {
      display:none;
      position: fixed; /* Stays in a fixed position relative to the viewport */
      top: 55px; /* Positioned just below the summary bar (approx. 8px padding + 8px padding + 8px height of summary bar) */
      left: 50%;
      transform: translateX(-50%); /* Centers horizontally */
      width: 95%;
      max-width: 500px;
      max-height:80%;
      overflow-y:auto;
      background:#fff; border:2px solid #ccc; padding:15px;
      border-radius:12px; /* Rounded corners for the entire modal */
      box-shadow:0 5px 20px rgba(0,0,0,0.3);
      z-index:999; /* Ensures it is on top of everything else */
      font-family: Arial, sans-serif;
    }
    #cartModal h3 {
      margin-top: 0;
      text-align: center;
      color: #d81b60;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
#cartModal .subtitle { /* NEW STYLE */
  text-align: center;
  font-size: 11px; /* Makes the font small */
  color: #777; /* Makes the font gray */
  margin-top: -8px; /* Adjusts spacing from the title */
  margin-bottom: 10px;
}
    #cartModal .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        color: #aaa;
        background: none;
        border: none;
        cursor: pointer;
        border-radius: 50%; /* Make close button circular */
        width: 30px;
        height: 30px;
        line-height: 24px;
        text-align: center;
    }
    #cartItems {
        list-style: none;
        padding: 0;
    }
    #cartItems li {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      font-size:14px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    #cartItems .qty-control { margin:0 8px }
    .remove-btn {
      background:none; border:none; color:red;
      font-weight:bold; cursor:pointer; user-select:none;
      font-size:18px;
      padding: 0 4px;
      line-height: 1;
      border-radius: 5px; /* Slight rounding for remove button */
    }

    /* General Layout */
    .search-container { text-align:center; padding:10px; background:#fff; position:sticky; top:55px; z-index:10; box-shadow:0 2px 5px rgba(0,0,0,0.1) } /* Adjusted top for sticky search bar */
    .search-box {
      padding:8px 15px;
      width:90%;
      max-width:300px;
      font-size:14px;
      border:2px solid #ffb6c1;
      border-radius:20px; /* Rounded corners for search box */
      outline:none;
    }
    .sort-buttons, .category-buttons {
      display:flex; flex-wrap:wrap; justify-content:center; gap:5px; padding:8px; background:#fff;
    }
    .sort-button {
      background:#f48fb1; color:#fff; border:none;
      border-radius:15px; /* Rounded corners for sort buttons */
      padding:10px 18px; font-size:16px; cursor:pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select:none;
      transition: background 0.3s ease;
    }
    .sort-button:hover:not(.active) { background: #f06292 }
    .sort-button.active { background:#d81b60; font-weight:bold }
    .category-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 10px; padding: 8px; background: #fff; margin-bottom: 10px;
    }
    .category-button {
      display: flex; flex-direction: column; align-items: center;
      background: #f48fb1; color: #fff; border: none; border-radius: 15px; /* Rounded corners for category buttons */
      padding: 8px 6px; font-size: 12px; cursor: pointer; gap: 6px; height: 110px;
      justify-content: center; text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease, background 0.3s ease;
      user-select:none;
    }
    .category-button:hover {
      box-shadow: 0 0 12px #d81b60;
      background: #ec407a;
    }
    .category-button.active { background: #d81b60; font-weight: bold; box-shadow: 0 0 8px #d81b60 }
    .category-button img { width: 70px; height: 70px; object-fit: cover; border-radius: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.15) }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; padding:10px; background:#f5f5f5; min-height: 100px }
    .card { background:#fff; border-radius:8px; /* Rounded corners for product cards */ box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; flex-direction:column; height:100% }
    .card-img-container { position:relative; width:100%; padding-top:100% }
    .card img { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; border-radius:8px; /* Rounded corners for product images */ }
    .card-body { padding:8px; flex-grow:1; display:flex; flex-direction:column }
    .card-title { font-size:12px; font-weight:bold; line-height:1.3; margin:0 0 4px; height:2.6em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical }
    .card-description { font-size:11px; color:#555; margin:0 0 6px; height:3em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical }
    .card-price { font-size:12px;color:#333;font-weight:bold;margin:0 0 4px }
    .card-stock { font-size:12px; margin:0 0 4px; color:green }
    .card-stock.out { color:#f44336 }
    .card-barcode { font-size:12px;color:#666;margin:0 0 4px }
    .qty-control { display:flex; align-items:center; margin:5px 0 }
    .qty-btn {
      width:24px; height:24px;
      background:#ffb6c1; color:#fff; border:none;
      border-radius:15px; /* Make quantity buttons circular/oval */
      cursor:pointer; font-weight:bold; user-select:none; transition: background 0.3s ease
    }
    .qty-btn:hover { background: #d81b60 }
    .qty-input {
      width:35px; text-align:center; margin:0 5px;
      border:1px solid #ddd;
      border-radius:15px; /* Rounded corners for quantity input */
      font-size:12px; padding:2px 5px
    }
    .order-btn {
      background:#ff80ab; color:#fff; border:none;
      padding:6px; font-size:11px;
      border-radius:15px; /* Rounded corners for "Add to Cart" button */
      margin-top:auto; cursor:pointer; text-align:center; user-select:none; transition: background 0.3s ease
    }
    .order-btn:hover:not(:disabled) { background: #d81b60 }
    .order-btn[disabled] { background:#ccc; color:#888; cursor:not-allowed }
    @media (min-width:768px) { .grid { grid-template-columns:repeat(3,1fr) } .card-title { font-size:14px } .order-btn { font-size:12px } }
    @media (min-width:1024px) { .grid { grid-template-columns:repeat(4,1fr); gap:15px; padding:15px } }
    .flying-image { position: fixed; width: 50px; height: 50px; border-radius: 8px; pointer-events: none; z-index: 2000; transition: transform 0.8s cubic-bezier(0.65, 0, 0.35, 1), opacity 0.8s ease; will-change: transform, opacity }
    .qty-hint { font-size: 9px; color: #777; margin-top: 2px; margin-bottom: 6px; display: inline-block }
  </style>
</head>
<body>

<div id="summaryCartBar" onclick="toggleCart()">
  <span id="summaryCartInfo">
    Shopping Cart (<span id="summaryCartCount">0</span>) - <span id="summaryCartTotal">0</span> MMK
  </span>
  <button id="viewCartBtn" type="button">ğŸ›’ á€…á€»á€±á€¸á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸ & Order á€á€„á€ºá€›á€”á€º</button>
</div>

<div class="search-container">
  <input id="searchInput" class="search-box" placeholder="á€›á€¾á€¬á€›á€”á€º~á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸/á€”á€¬á€™á€Šá€º/barcode" autocomplete="off" />
</div>

<div class="sort-buttons">
  <button class="sort-button" onclick="toggleCategories()">ğŸ‡ğŸ“‚ All Category & Home ğŸ‡ğŸ“</button>
  <button class="sort-button" onclick="sortByPrice()">ğŸ’²Price</button>
  <button class="sort-button" onclick="sortByStock()">ğŸ“¦Stock</button>
  <button class="sort-button" onclick="sortByName()">ğŸ”¤Name</button>
  <button class="sort-button" onclick="sortByDate()">ğŸ›³ï¸á€¡á€á€…á€ºá€›á€±á€¬á€€á€ºá€•á€…á€¹á€…á€Šá€ºá€¸á€™á€»á€¬á€¸</button>
</div>

<div class="category-buttons" id="categoryButtons" style="display:none;"></div>
<div id="tagFilters" style="display:none; padding: 5px 10px; font-size: 13px; color: #555;"></div>
<div class="grid" id="productGrid">Please select a category.</div>

<div id="cartModal" role="dialog" aria-modal="true" aria-labelledby="cartTitle" tabindex="-1">
  <button class="close-btn" onclick="toggleCart()" aria-label="Close cart">&times;</button>
  <h3 id="cartTitle">Your Cart</h3>
    <p class="subtitle">(Order List á€€á€­á€¯ Screenshot á€›á€­á€¯á€€á€ºáá€œá€Šá€ºá€¸ Chatbox á€á€½á€„á€º á€•á€±á€¸á€•á€­á€¯á€· á€™á€¾á€¬á€šá€°á€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€º)</p>
  <ul id="cartItems"></ul>
  <p style="text-align:right; font-weight:bold; font-size:16px; margin-top: 10px;">Total: <span id="cartTotal">0</span> MMK</p>

  <button onclick="checkoutCartTelegram()" style="background:#ff80ab;color:#fff;border:none;padding:8px 12px;border-radius:15px;cursor:pointer;width:100%; margin-top:10px;">
    ğŸŒ¸ Telegram á€á€½á€„á€º order á€á€„á€ºá€›á€”á€ºğŸŒ¸
  </button>
  <button onclick="checkoutCartSMS()" style="background:#76955E;color:#fff;border:none;padding:8px 12px;border-radius:15px;cursor:pointer;width:100%; margin-top:8px;">
    ğŸ“— á€–á€¯á€”á€ºá€¸ Message (SMS) á€–á€¼á€„á€·á€º Order á€á€„á€ºá€›á€”á€ºğŸ“—
  </button>
  <button onclick="checkoutCartMessenger()" style="background:#1877f2;color:#fff;border:none;padding:8px 12px;border-radius:15px;cursor:pointer;width:100%; margin-top:8px;">
    ğŸ§â€â™‚ï¸ Facebook Messenger á€á€½á€„á€º order á€á€„á€ºá€›á€”á€ºğŸ§â€â™‚ï¸ âš ï¸á€á€œá€¯á€•á€ºá€”á€¾á€­á€•á€ºá€œá€­á€¯á€€á€ºá€•á€«á€€ Order List á€€á€­á€¯ Auto Copy á€œá€¯á€•á€ºá€•á€±á€¸á€•á€«á€™á€Šá€º Messenger á€á€½á€„á€º Paste á€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸ Order á€á€„á€ºá€•á€«âš ï¸
  </button>
  <button onclick="checkoutCartViber()" style="background:#665CAC;color:#fff;border:none;padding:8px 12px;border-radius:15px;cursor:pointer;width:100%; margin-top:8px;">
    ğŸ’œ Viber á€–á€¼á€„á€·á€º Order á€á€„á€ºá€›á€”á€º ğŸ’œ âš ï¸á€á€œá€¯á€•á€ºá€”á€¾á€­á€•á€ºá€œá€­á€¯á€€á€ºá€•á€«á€€ Order List á€€á€­á€¯ Auto Copy á€œá€¯á€•á€ºá€•á€±á€¸á€•á€«á€™á€Šá€º Viber á€á€½á€„á€º Paste á€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸ Order á€á€„á€ºá€•á€«âš ï¸
  </button>
</div>


<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT9-zQ455LgQYJ4-Jb1cs708CMLrut0Ql2nXaX6ICnfwpNPVlDrdsyWhYDGrxm6WkPOCpMmf6Npry6U/pub?output=tsv';

let allItems = [], categories = [], cart = JSON.parse(localStorage.getItem('cart')||'[]'), currentCategory = null;
let currentSort = null;
let tagFilter = null; // This will hold the currently active tag filter

async function fetchProducts(){
  const res = await fetch(sheetURL);
  const txt = await res.text();
  const rows = txt.trim().split('\n').map(r=>r.split('\t'));
  const keys = rows.shift().map(k=>k.trim().toLowerCase());
  allItems = rows.map(r=>{
    const o = {};
    keys.forEach((k,i)=>{ o[k]=r[i]||'' });
    // Ensure 'tag' property exists and is a string
    o.tag = (o.tag || '').trim();
    return o;
  });


const allImageSrc = 'https://img1.wsimg.com/isteam/ip/5261877d-8f6b-47bd-9252-5d4d6c9a0ecb/2BD32194-B579-4C49-9883-E1FBD3C9A3E6.png/:/rs=w:1440,h:1440';

  categories = allItems.map(p=>p.category).filter(c=>c);
  generateCategoryButtons(allImageSrc);
  document.getElementById('productGrid').innerHTML = '<p style="grid-column:1/-1;text-align:center;">Category á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«</p>';
  renderCart();
}

function generateCategoryButtons(allImageSrc){
  const cb = document.getElementById('categoryButtons');
  cb.innerHTML = '';
  const uniqueCats = [...new Set(categories)].sort();
  const allButton = document.createElement('button');
  allButton.className = 'category-button';
  allButton.innerHTML = `<img src="${allImageSrc}" alt="All" loading="lazy"><span>All</span>`;
  if(currentCategory==='All') allButton.classList.add('active');
  allButton.onclick = () => {
    currentCategory = 'All';
    tagFilter = null; // Reset tag filter when "All" category is selected
    setActiveCategoryButton(cb, allButton);
    renderProducts(filteredItems());
    cb.style.display = 'none';
  };
  cb.appendChild(allButton);

  uniqueCats.forEach(cat=>{
    if(cat.toLowerCase() === 'all') return;
    const imgSrc = allItems.find(p=>p.category === cat)?.categoryimage || 'https://via.placeholder.com/70?text=No+Image';
    const b = document.createElement('button');
    b.className = 'category-button';
    if(currentCategory === cat) b.classList.add('active');
    b.innerHTML = `<img src="${imgSrc}" alt="${cat}" loading="lazy" onerror="this.src='https://via.placeholder.com/70?text=No+Image'"><span>${cat}</span>`;
    b.onclick = () => {
      tagFilter = null; // Reset tag filter when a new category is selected
      currentCategory = cat;
      setActiveCategoryButton(cb, b);
      renderProducts(filteredItems());
      cb.style.display = 'none';
    };
    cb.appendChild(b);
  });
  cb.style.display = 'grid';
}
function setActiveCategoryButton(container, activeBtn){
  container.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
  activeBtn.classList.add('active');
}
function toggleCategories(){
  const cb = document.getElementById('categoryButtons');
  cb.style.display = cb.style.display === 'grid' ? 'none' : 'grid';
  if(cb.style.display === 'grid' && !currentCategory) {
    document.getElementById('productGrid').innerHTML = '<p style="grid-column:1/-1;text-align:center;">Category á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«</p>';
  }
}

function filteredItems(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  let items = allItems;

  if (q) {
    items = items.filter(p =>
      (p.name||'').toLowerCase().includes(q) ||
      (p.barcode||'').toLowerCase().includes(q) ||
      (p.tag||'').toLowerCase().includes(q)
    );
  } else if (currentCategory && currentCategory !== 'All') {
    items = items.filter(p => p.category === currentCategory);
  } else if (currentCategory === 'All' && !q) {
    items = allItems;
  } else {
    return [];
  }

  if (tagFilter && !q) {
    items = items.filter(p => p.tag === tagFilter);
  }

  return items;
}

function filterByTag(tagName){
  tagFilter = tagFilter === tagName ? null : tagName;
  document.getElementById('searchInput').value = '';
  renderProducts(filteredItems());
}

function sortItems(items){
  switch(currentSort){
    case 'Price':
      return items.slice().sort((a, b) => (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0));
    case 'Stock':
      return items.slice().sort((a, b) => (parseInt(b.stock) || 0) - (parseInt(a.stock) || 0));
    case 'Name':
      return items.slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    case 'Date':
      return items.slice().sort((a, b) => {
        const dA = new Date(a.date || a['receiveddate'] || '2000-01-01');
        const dB = new Date(b.date || b['receiveddate'] || '2000-01-01');
        return dB - dA;
      });
    default:
      return items;
  }
}

// MODIFIED: renderProducts function
function renderProducts(items){
  if (currentSort === 'Date') {
    items = items.filter(p => p.date && p.date.trim() !== '');
  }
  let sortedItems;
  if(currentSort){
    sortedItems = sortItems(items);
  } else {
    const withImage = items.filter(p => p.image && p.image.trim() !== '');
    const withoutImage = items.filter(p => !p.image || p.image.trim() === '');
    withImage.sort((a,b) => (parseInt(b.stock)||0) - (parseInt(a.stock)||0));
    withoutImage.sort((a,b) => (parseInt(b.stock)||0) - (parseInt(a.stock)||0));
    sortedItems = [...withImage, ...withoutImage];
  }
  const grid = document.getElementById('productGrid');
  if(sortedItems.length === 0) {
    grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;">Category á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«áŠ á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º Search á€œá€¯á€•á€ºá€•á€«</p>';
    return;
  }
  const tagContainer = document.getElementById('tagFilters');
  const tags = [...new Set(items.map(p => p.tag).filter(Boolean))];

  if (tags.length > 0 && !document.getElementById('searchInput').value.trim()) {
    tagContainer.style.display = 'block';
    tagContainer.innerHTML = 'ğŸ”– Tag: ' + tags.map(t => `
      <button onclick="filterByTag('${t}')" style="
        background: ${tagFilter === t ? '#d81b60' : '#f48fb1'};
        color: ${tagFilter === t ? '#fff' : '#fff'};
        border: none;
        padding: 4px 8px;
        margin: 2px;
        border-radius: 12px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      ">${t}</button>
    `).join('');
  } else {
    tagContainer.style.display = 'none';
  }

  grid.innerHTML = '';
  sortedItems.forEach(p=>{
    const stock = parseInt(p.stock)||0;
    // MODIFIED: Get current quantity from cart, or 1 if not in cart (default to 1)
    const inCart = (cart.find(c=>c.barcode===p.barcode)||{}).qty || 0;
    const initialQty = inCart > 0 ? inCart : 1; // Default to 1 if not in cart, otherwise use cart quantity
    
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-img-container">
        <img src="${p.image || 'https://via.placeholder.com/300?text=No+Image'}" alt="${p.name}" loading="lazy" />
      </div>
      <div class="card-body">
        <h4 class="card-title" title="${p.name}">${p.name}</h4>
        <p class="card-description" title="${p.description}">${p.description || ''}</p>
        <p class="card-price">Price: ${p.price} MMK</p>
        <p class="card-stock ${stock===0?'out':''}">Stock: ${stock}</p>
        <p class="card-barcode">Barcode: ${p.barcode}</p>
        <div class="qty-control">
          <button class="qty-btn" aria-label="Reduce quantity" onclick="updateLocalQuantity('${p.barcode}', -1, this)">-</button>
          <input type="number" class="qty-input" min="0" max="${stock}" value="${initialQty}" 
                 onchange="onQtyInputChangeInProductCard('${p.barcode}', this)" 
                 aria-label="Quantity for ${p.name}" data-barcode="${p.barcode}" />
          <button class="qty-btn" aria-label="Increase quantity" onclick="updateLocalQuantity('${p.barcode}', 1, this)">+</button>
        </div>
        <span class="qty-hint">á€á€šá€ºá€šá€°á€œá€­á€¯á€á€Šá€·á€ºá€¡á€›á€±á€¡á€á€½á€€á€ºá€–á€¼á€Šá€·á€ºá€›á€”á€º</span>
        <button class="order-btn" onclick="addToCart('${p.barcode}')" ${stock === 0 ? 'disabled' : ''}>Add to Cart</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

// NEW FUNCTION: Update quantity displayed in product card (not directly in cart)
function updateLocalQuantity(barcode, delta, buttonElement) {
  const input = buttonElement.closest('.qty-control').querySelector('.qty-input');
  let currentVal = parseInt(input.value) || 0;
  let newVal = currentVal + delta;

  if (newVal < 1) newVal = 1; // MODIFIED: Minimum quantity for product card is 1
  const maxStock = getProductStock(barcode);
  if (newVal > maxStock) newVal = maxStock;
  
  input.value = newVal;
  // Update button states based on new value
  const minusBtn = input.parentElement.querySelector('button[aria-label="Reduce quantity"]');
  const plusBtn = input.parentElement.querySelector('button[aria-label="Increase quantity"]');
  minusBtn.disabled = newVal <= 1; // Disable minus if 1 or less
  plusBtn.disabled = newVal >= maxStock; // Disable plus if max stock reached
}

// NEW FUNCTION: Handle quantity input change in product card
function onQtyInputChangeInProductCard(barcode, input) {
  let val = parseInt(input.value) || 0;
  if (val < 1) val = 1; // MODIFIED: Minimum quantity for product card is 1
  const maxStock = getProductStock(barcode);
  if (val > maxStock) val = maxStock;
  input.value = val;

  // Update button states based on new value
  const minusBtn = input.parentElement.querySelector('button[aria-label="Reduce quantity"]');
  const plusBtn = input.parentElement.querySelector('button[aria-label="Increase quantity"]');
  minusBtn.disabled = val <= 1; // Disable minus if 1 or less
  plusBtn.disabled = val >= maxStock; // Disable plus if max stock reached
}


// MODIFIED: addToCart function
function addToCart(barcode){
  const input = document.querySelector(`.qty-input[data-barcode="${barcode}"]`);
  if (!input) return;

  let qty = parseInt(input.value) || 0;
  if (qty <= 0) { // If quantity is 0 or less, effectively remove from cart
      updateCart(barcode, 0); 
  } else {
      updateCart(barcode, qty);
      animateAddToCart(barcode);
  }
}

// MODIFIED: changeQuantity function (only used in cart modal now)
function changeQuantity(barcode, delta){
  const product = getProduct(barcode);
  if (!product) return;
  
  let currentVal = (cart.find(c => c.barcode === barcode) || {}).qty || 0;
  let newVal = currentVal + delta;
  
  if (newVal < 0) newVal = 0; // In cart modal, 0 is allowed (means removal)
  const maxStock = getProductStock(barcode);
  if (newVal > maxStock) newVal = maxStock;
  
  updateCart(barcode, newVal);
}

// MODIFIED: onQtyInputChange (only used in cart modal now)
function onQtyInputChange(barcode, input){
  let val = parseInt(input.value) || 0;
  if(val < 0) val = 0; // In cart modal, 0 is allowed
  const maxStock = getProductStock(barcode);
  if(val > maxStock) val = maxStock;
  input.value = val;
  updateCart(barcode, val);
}

function updateCart(barcode, qty){
  let found = cart.find(c=>c.barcode === barcode);
  if(qty <= 0){
    cart = cart.filter(c => c.barcode !== barcode);
  } else {
    if(found){
      found.qty = qty;
    } else {
      cart.push({barcode, qty});
    }
  }
  saveCart();
  renderCart();
  // Update the product card's quantity input to reflect actual cart quantity
  const productCardInput = document.querySelector(`.qty-input[data-barcode="${barcode}"]`);
  if (productCardInput) {
      const currentCartQty = (cart.find(c => c.barcode === barcode) || {}).qty || 1; // Default to 1 if not in cart
      productCardInput.value = currentCartQty;
      // Also update its +/- button states
      const minusBtn = productCardInput.parentElement.querySelector('button[aria-label="Reduce quantity"]');
      const plusBtn = productCardInput.parentElement.querySelector('button[aria-label="Increase quantity"]');
      const maxStock = getProductStock(barcode);
      minusBtn.disabled = currentCartQty <= 1;
      plusBtn.disabled = currentCartQty >= maxStock;
      
      // If item was just added/quantity changed in cart, enable/disable Add to Cart button based on stock
      const orderBtn = productCardInput.closest('.card-body').querySelector('.order-btn');
      if (orderBtn) {
          orderBtn.disabled = maxStock === 0;
      }
  }
}

function removeFromCart(barcode){
  cart = cart.filter(c=>c.barcode !== barcode);
  saveCart();
  // Call renderProducts with currently filtered items to ensure display is correct
  renderProducts(filteredItems()); 
  renderCart();
}

function saveCart(){
  localStorage.setItem('cart', JSON.stringify(cart));
}

function getProduct(barcode){ return allItems.find(p=>p.barcode === barcode) }
function getProductStock(barcode){ const p = getProduct(barcode); return p ? (parseInt(p.stock) || 0) : 0 }
function getProductName(barcode){ const p = getProduct(barcode); return p ? p.name : '' }

// MODIFIED renderCart function
function renderCart(){
  const summaryCountEl = document.getElementById('summaryCartCount');
  const summaryTotalEl = document.getElementById('summaryCartTotal');
  const modalUl = document.getElementById('cartItems');
  const modalTotalEl = document.getElementById('cartTotal');
  const cartModal = document.getElementById('cartModal');

  const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
  const totalPrice = cart.reduce((sum, c) => {
    const p = getProduct(c.barcode);
    return sum + ((parseFloat(p?.price) || 0) * c.qty);
  }, 0);

  // Always update summary bar content
  summaryCountEl.textContent = totalItems;
  summaryTotalEl.textContent = totalPrice.toLocaleString();

  // If cart becomes empty while modal is open, hide modal
  if (cart.length === 0 && cartModal.style.display === 'block') {
    cartModal.style.display = 'none';
  }

  // Always update modal content in the background
  modalUl.innerHTML = '';
  if(cart.length === 0) {
      modalUl.innerHTML = '<li style="text-align:center; border:none;">Your cart is empty.</li>';
  } else {
      cart.forEach(c => {
        const p = getProduct(c.barcode);
        if(!p) return;
        const lineTotal = (parseFloat(p.price) || 0) * c.qty;
        
        const li = document.createElement('li');
        li.innerHTML = `
          <img src="${p.image || 'https://via.placeholder.com/40?text=No+Img'}" alt="${p.name}" style="width:40px; height:40px; object-fit:cover; border-radius:6px; margin-right:8px; flex-shrink:0;" />
          <span style="flex-grow:1;">${p.name} (${p.barcode})</span>
          <div class="qty-control" style="margin:0;">
            <button class="qty-btn" aria-label="Reduce quantity" onclick="changeQuantity('${c.barcode}', -1)">-</button>
            <input type="number" class="qty-input" min="0" max="${parseInt(p.stock)||0}" value="${c.qty}" onchange="onQtyInputChange('${c.barcode}', this)" aria-label="Quantity for ${p.name}" />
            <button class="qty-btn" aria-label="Increase quantity" onclick="changeQuantity('${c.barcode}', 1)">+</button>
          </div>
          <span>${lineTotal.toLocaleString()} MMK</span>
          <button class="remove-btn" title="Remove" onclick="removeFromCart('${c.barcode}')">&times;</button>
        `;
        modalUl.appendChild(li);
      });
  }
  modalTotalEl.textContent = totalPrice.toLocaleString();
}

function toggleCart(){
  const modal = document.getElementById('cartModal');
  if(modal.style.display === 'block'){
    modal.style.display = 'none';
  } else {
    renderCart();
    modal.style.display = 'block';
    modal.focus();
  }
}

function animateAddToCart(barcode){
  const productImg = document.querySelector(`.card img[alt="${getProductName(barcode)}"]`);
  if(!productImg) return;

  const cartTarget = document.getElementById('summaryCartBar');
  if(!cartTarget) return;

  const imgRect = productImg.getBoundingClientRect();
  const cartRect = cartTarget.getBoundingClientRect();

  const flyingImg = productImg.cloneNode(true);
  flyingImg.classList.add('flying-image');
  flyingImg.style.top = imgRect.top + 'px';
  flyingImg.style.left = imgRect.left + 'px';
  flyingImg.style.width = imgRect.width + 'px';
  flyingImg.style.height = imgRect.height + 'px';
  flyingImg.style.opacity = '1';

  document.body.appendChild(flyingImg);
  flyingImg.getBoundingClientRect();

  flyingImg.style.transform = `translate(${cartRect.left - imgRect.left + cartRect.width/2}px, ${cartRect.top - imgRect.top}px) scale(0.1)`;
  flyingImg.style.opacity = '0.5';

  flyingImg.addEventListener('transitionend', () => { flyingImg.remove() });
}

document.getElementById('searchInput').addEventListener('input', () => {
  const q = document.getElementById('searchInput').value.trim();
  currentCategory = null;
  tagFilter = null;
  document.getElementById('categoryButtons').style.display = 'none';
  document.getElementById('tagFilters').style.display = 'none';
  renderProducts(filteredItems());
});
function clearSortButtons(){
  document.querySelectorAll('.sort-button').forEach(btn => btn.classList.remove('active'));
}
function sortByPrice(){
  if(currentSort === 'Price') {
    currentSort = null;
    clearSortButtons();
  } else {
    currentSort = 'Price';
    clearSortButtons();
    document.querySelectorAll('.sort-button')[1].classList.add('active');
  }
  renderProducts(filteredItems());
}
function sortByStock(){
  if(currentSort === 'Stock') {
    currentSort = null;
    clearSortButtons();
  } else {
    currentSort = 'Stock';
    clearSortButtons();
    document.querySelectorAll('.sort-button')[2].classList.add('active');
  }
  renderProducts(filteredItems());
}
function sortByName(){
  if(currentSort === 'Name') {
    currentSort = null;
    clearSortButtons();
  } else {
    currentSort = 'Name';
    clearSortButtons();
    document.querySelectorAll('.sort-button')[3].classList.add('active');
  }
  renderProducts(filteredItems());
}
function sortByDate() {
  if(currentSort === 'Date') {
    currentSort = null;
    clearSortButtons();
    document.querySelector('.category-buttons').style.display = 'none';
    renderProducts(filteredItems());
  } else {
    currentSort = 'Date';
    clearSortButtons();
    document.querySelectorAll('.sort-button')[4].classList.add('active');
    document.querySelector('.category-buttons').style.display = 'none';
    const itemsWithDate = allItems.filter(p => p.date && p.date.trim() !== '');
    renderProducts(itemsWithDate);
  }
}
function getOrderListMessage(){
  if(cart.length === 0) return '';
  let msg = 'ğŸ›’ Order List:\n';
  cart.forEach(c => {
    const p = getProduct(c.barcode);
    if(p){
      msg += `- ${p.name} (Barcode: ${p.barcode}) x${c.qty} = ${(parseFloat(p.price) || 0) * c.qty} MMK\n`;
    }
  });
  const total = cart.reduce((sum,c) => {
    const p = getProduct(c.barcode);
    return sum + ((parseFloat(p?.price)||0) * c.qty);
  }, 0);
  msg += `Total: ${total.toLocaleString()} MMK\n\n`;
  msg += 'ğŸ“ á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á Delivery á€•á€­á€¯á€·á€†á€±á€¬á€„á€ºá€›á€”á€ºá€¡á€á€½á€€á€º á€¡á€™á€Šá€º / á€–á€¯á€”á€ºá€¸ / á€œá€­á€•á€ºá€…á€¬ á€•á€±á€¸á€•á€«á€›á€”á€º';
  return msg;
}
function checkoutCartTelegram() {
  const msg = getOrderListMessage();
  if (!msg) { alert('Please add products to cart before checkout.'); return }
  const sendUrl = `https://t.me/${encodeURIComponent('QODAdminmdy')}?text=${encodeURIComponent(msg)}`;
  window.open(sendUrl, '_blank');
}
function checkoutCartSMS(){
  const msg = encodeURIComponent(getOrderListMessage());
  if(!msg) return alert('Cart is empty');
  const smsUrl = `sms:+959977140017?&body=${msg}`;
  window.open(smsUrl, '_blank');
}
function copyToClipboard(text){
  if(navigator.clipboard && window.isSecureContext){
    return navigator.clipboard.writeText(text);
  } else {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    return new Promise((res, rej) => {
      document.execCommand('copy') ? res() : rej();
      textarea.remove();
    });
  }
}
function checkoutCartMessenger(){
  const msg = getOrderListMessage();
  if(!msg) return alert('Cart is empty');
  copyToClipboard(msg).then(() => {
    alert('Order list copied! Please paste in Messenger.');
    window.open('https://m.me/487447328059855', '_blank');
  }).catch(()=>{
    alert('Failed to copy. Please copy manually.');
    window.open('https://m.me/487447328059855', '_blank');
  });
}
function checkoutCartViber(){
  const msg = getOrderListMessage();
  if(!msg){ alert('Please add products to cart before checkout.'); return }
  copyToClipboard(msg).then(() => {
    alert('Order list copied! Please paste in Viber chat.');
    window.open('viber://chat?number=%2B959982828585', '_blank');
  }).catch(() => {
    alert('Failed to copy. Please copy manually.');
    window.open('viber://chat?number=%2B959982828585', '_blank');
  });
}

fetchProducts();
</script>
</body>
</html>
C 700.353 

